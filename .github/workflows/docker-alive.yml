import fetch from "node-fetch";

const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const TELEGRAM_CHAT_ID = process.env.TELEGRAM_CHAT_ID;

const REPO = process.env.GITHUB_REPOSITORY; // chainfyre/docker-alive
const RUN_ID = process.env.GITHUB_RUN_ID;
const RUN_URL = `https://github.com/${REPO}/actions/runs/${RUN_ID}`;

if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
  console.error("Missing TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID");
  process.exit(1);
}

const message =
  `[docker-keepalive][manual] Success. Repo: ${REPO}\n` +
  `${RUN_URL}`;

const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;

await fetch(url, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    chat_id: TELEGRAM_CHAT_ID,
    text: message,
    disable_web_page_preview: true, // important
  }),
});

console.log("Telegram notification sent");
